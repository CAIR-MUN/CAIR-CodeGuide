name: Sync Wiki to docs (GitHub Pages)

on:
  push:
    branches: [main, master]
  workflow_dispatch: {}

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Clone wiki repository
        env:
          REPO: ${{ github.repository }}
        run: |
          set -e
          git clone "https://github.com/${{ github.repository }}.wiki.git" wiki

      - name: Copy wiki pages into docs/
        run: |
          set -e
          mkdir -p docs
          # Copy markdown files from the wiki repo into docs
          rsync -av --delete --exclude='.git' wiki/ ./docs/
          # Remove any wiki-only files we don't want in Pages
          rm -f docs/_Sidebar.md docs/_Footer.md || true

      - name: Convert links (strip .md) in copied files
        run: |
          set -e
          # Replace .md links with link to page path (GitHub Pages serves by path)
          find docs -name '*.md' -print0 | xargs -0 sed -E -i 's/(\]\([^)]*)\.md\)/\1\)/g' || true

      - name: Add Jekyll front matter to docs pages
        run: |
          set -e
          # Remove .nojekyll if present to ensure Jekyll builds
          rm -f docs/.nojekyll || true

          python3 - <<'PY'
          import os, re
          from pathlib import Path

          def slugify(name):
              s = re.sub(r"\s+", '-', name)
              s = re.sub(r'[^A-Za-z0-9\-_.]', '', s)
              return s.strip('-').lower()

          for md in Path('docs').rglob('*.md'):
              # skip files that already have front matter
              try:
                  text = md.read_text(encoding='utf-8')
              except Exception:
                  continue
              if text.lstrip().startswith('---'):
                  continue
              # extract a title from first heading or filename
              title = None
              for line in text.splitlines():
                  m = re.match(r'^#\s+(.*)', line)
                  if m:
                      title = m.group(1).strip()
                      break
              if not title:
                  title = md.stem.replace('-', ' ').replace('_',' ').strip()
              slug = slugify(md.stem)
              fm = f"---\nlayout: default\ntitle: \"{title}\"\npermalink: /{slug}/\n---\n\n"
              md.write_text(fm + text, encoding='utf-8')
          print('Prepended front matter to docs pages where missing')
          PY

      - name: Commit and push docs/ updates
        run: |
          set -e
          git add docs
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Docs(site): sync wiki -> docs for GitHub Pages" || true
            git push origin HEAD:$(git rev-parse --abbrev-ref HEAD)
          else
            echo "No changes to commit"
          fi
